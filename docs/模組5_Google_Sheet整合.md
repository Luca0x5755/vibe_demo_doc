# 📦 模組5: Google Sheet 整合

## 1️⃣ 第一性原理拆解

**核心知識點：API 整合 (API Integration)**

```
最根本的問題：
「怎麼讓兩個不同的系統互相傳資料？」

生活類比：
├─ 郵局：寄信到指定地址→API呼叫
├─ 自動販賣機：投幣→取貨→API請求與回應
└─ 餐廳外送：下單→店家收單→外送員送達→多系統協作

軟體中的實現：
請求(Request) + 回應(Response) + 資料格式(JSON) = API溝通
```

**拆解成3個子問題：**
1. **認證授權**：「怎麼證明我有權限操作別人的系統？」
2. **資料轉換**：「我的資料格式跟對方的一樣嗎？」
3. **錯誤處理**：「如果對方系統掛了怎麼辦？」

---

## 2️⃣ 模組設計

### 設計目標
每週自動將訂單資料匯出到 Google Sheet，方便會計對帳。

### 整合流程圖

```
觸發點：每週五晚上 11:50（定時任務）
│
├─ 步驟1：從資料庫抓取本週訂單
│   └─ SELECT * FROM orders WHERE order_date >= '本週一'
│
├─ 步驟2：資料整理（轉換格式）
│   ├─ 原始資料：JSON格式
│   └─ 轉換成：表格行列格式
│
├─ 步驟3：連接 Google Sheet API
│   ├─ 認證：使用服務帳號金鑰
│   └─ 取得試算表ID
│
├─ 步驟4：寫入資料
│   ├─ 清空舊資料（或新增分頁）
│   ├─ 寫入表頭：訂單編號、日期、客戶、金額、狀態
│   └─ 逐行寫入訂單資料
│
└─ 步驟5：通知完成
    └─ 寄信給會計：「本週報表已更新」
```

### 試算表格式

| 工作表 | 內容 |
|-------|------|
| 本週訂單摘要 | 訂單編號、日期、客戶名稱、商品清單、金額、狀態 |
| 統計資訊 | 總訂單數、總金額、各狀態訂單數量 |

### 可維護性設計：容錯機制

| 機制 | 說明 |
|------|------|
| **連線逾時處理** | 10秒內沒回應→重試3次→失敗寄信通知 |
| **資料驗證** | 匯出前檢查資料完整性，空值填0 |
| **本地備份** | 寫入 Google Sheet 同時存 CSV 到本地 |
| **執行日誌** | 記錄時間、筆數、是否成功 |

---

## 3️⃣ AI 協作開發提示詞

### 完整 Prompt 範本

```markdown
# Google Sheet 整合需求

## 目標
每週自動將訂單資料匯出到 Google Sheet，方便會計對帳。

## 資料來源
從 Supabase 的 orders 和 order_items 表抓取資料。

## 目標試算表
- Google Sheet 名稱：「訂單週報表」
- Sheet ID：1234567890abcdef（請用這個ID）

## 試算表格式

**工作表1：本週訂單摘要**
欄位：
- A欄：訂單編號
- B欄：訂單日期
- C欄：客戶名稱
- D欄：商品清單（多項商品用逗號分隔）
- E欄：訂單金額
- F欄：訂單狀態

**工作表2：統計資訊**
- 總訂單數
- 總金額
- 各狀態訂單數量（待處理、已完成...）

## 執行時機
每週五晚上 11:50 執行（使用排程器）

## 認證方式
使用 Google Service Account 認證
金鑰檔案路徑：./config/google-credentials.json

## 流程
1. 查詢本週訂單（星期一 00:00 至星期日 23:59）
2. 轉換成試算表格式
3. 清空「本週訂單摘要」工作表的舊資料
4. 寫入新資料
5. 更新「統計資訊」工作表
6. 發送 email 通知：「本週報表已更新，共X筆訂單」

## 錯誤處理
- 如果連不上 Google API → 重試3次，失敗則寄信通知管理員
- 如果沒有訂單 → 依然建立試算表，顯示「本週無訂單」

請幫我生成這個整合程式的 Python 程式碼。
```

### 容錯機制 Prompt

```markdown
請在程式中加入以下處理：

1. 連線逾時處理
   - 如果10秒內沒回應→重試
   - 重試3次都失敗→記錄錯誤，寄信通知

2. 資料驗證
   - 匯出前檢查資料是否完整
   - 如果金額欄位有空值→填0

3. 本地備份
   - 除了寫入 Google Sheet，也存一份 CSV 在本地
   - 檔名：weekly_report_20250110.csv

4. 執行日誌
   - 每次執行記錄：時間、筆數、是否成功
   - 日誌存在：./logs/sheet_sync.log
```

---

## 4️⃣ 手動功能測試說明

### 測試環境準備
1. 設定 Google Cloud Project
2. 建立 Service Account 並下載金鑰
3. 在 Google Sheet 共用權限給 Service Account
4. 確認 Supabase 有測試訂單資料

### 測試案例清單

| 編號 | 測試項目 | 測試步驟 | 預期結果 |
|------|---------|---------|---------|
| T01 | 基本同步 | 手動執行同步腳本 | Google Sheet 出現訂單資料 |
| T02 | 增量更新 | 新增訂單後再次同步 | 新訂單出現在報表中 |
| T03 | 空資料處理 | 清空資料庫訂單後同步 | 報表顯示「本週無訂單」 |
| T04 | 重試機制 | 模擬網路斷線後恢復 | 自動重試並成功 |
| T05 | 本地備份 | 執行同步後檢查本地 | CSV 檔案已建立 |
| T06 | 日誌記錄 | 檢查 logs 目錄 | 執行記錄已寫入 |
| T07 | 排程執行 | 設定定時任務等待觸發 | 自動執行同步 |

### 異常情況處理

| 異常情況 | 預期系統反應 |
|---------|-------------|
| API 金鑰過期 | 記錄錯誤，寄信通知管理員 |
| Sheet 被刪除 | 記錄錯誤，不中斷其他流程 |
| 資料庫連線失敗 | 重試後失敗則記錄並通知 |
