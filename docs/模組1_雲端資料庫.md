# 📦 模組1: 雲端資料庫 Supabase

## 1️⃣ 第一性原理拆解

**核心知識點：資料建模 (Data Modeling)**

```
最根本的問題：
「現實世界的東西，怎麼存進電腦？」

生活類比：
├─ 圖書館書架：書分類擺放→資料表分類
├─ 書的借閱卡：記錄誰借了什麼→關聯資料
└─ 書目索引：快速找書→資料庫索引

軟體中的實現：
實體(Entity) + 屬性(Attribute) + 關係(Relationship) = 資料模型
```

**拆解成3個子問題：**
1. **實體識別**：「系統要存哪些『東西』？」
2. **屬性定義**：「每個『東西』有哪些特徵？」
3. **關係建立**：「『東西』之間如何連結？」

---

## 2️⃣ 模組設計

### 設計目標
建立完整的資料庫結構，確保資料完整性與查詢效率。

### ER 圖（實體關係圖）

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   使用者     │         │    訂單      │         │    商品      │
├──────────────┤         ├──────────────┤         ├──────────────┤
│ id (PK)      │1       ∞│ id (PK)      │        ∞│ id (PK)      │
│ username     ├─────────│ user_id (FK) │         │ name         │
│ email        │         │ order_date   │         │ price        │
│ role         │         │ status       │         │ stock        │
│ created_at   │         │ total_amount │         │ category     │
└──────────────┘         └──────┬───────┘         └──────┬───────┘
                                │                        │
                                │ ∞                     1│
                         ┌──────┴────────┐              │
                         │  訂單明細     │              │
                         ├───────────────┤              │
                         │ id (PK)       │              │
                         │ order_id (FK) ├──────────────┘
                         │ product_id (FK)
                         │ quantity      │
                         │ price         │
                         └───────────────┘
```

### 資料表設計

| 資料表 | 主要欄位 | 說明 |
|-------|---------|------|
| users | id, username, email, password_hash, role | 使用者資料 |
| products | id, name, price, stock, category, is_active | 商品資料 |
| orders | id, order_number, user_id, status, total_amount | 訂單主表 |
| order_items | id, order_id, product_id, quantity, unit_price | 訂單明細 |

### 資料完整性設計

| 設計原則 | 範例 | SQL 實現 |
|---------|------|----------|
| **非空約束** | email 不能為空 | `NOT NULL` |
| **唯一約束** | 帳號不能重複 | `UNIQUE` |
| **預設值** | 訂單狀態預設「待處理」 | `DEFAULT 'pending'` |
| **外鍵約束** | 訂單要對應到真實使用者 | `REFERENCES users(id)` |
| **檢查約束** | 數量不能是負數 | `CHECK (quantity >= 0)` |

---

## 3️⃣ AI 協作開發提示詞

### 完整 Prompt 範本

```markdown
# Supabase 資料庫結構設計

我需要為訂單管理系統建立資料庫，請幫我產生 Supabase 的 SQL 建表語法。

## 表1：使用者表 (users)

**欄位：**
- id：UUID，主鍵，自動產生
- username：文字，唯一，不能為空
- email：文字，唯一，不能為空
- password_hash：文字，不能為空
- role：文字，預設值'customer'，可選值(customer/admin/super_admin)
- created_at：時間戳記，預設當前時間

**索引：**
- username（加快查詢）
- email（加快查詢）

## 表2：商品表 (products)

**欄位：**
- id：UUID，主鍵
- name：文字，不能為空
- description：文字，可為空
- price：數字（小數點2位）
- stock：整數，預設0
- category：文字
- is_active：布林值，預設true（是否上架）
- created_at：時間戳記

## 表3：訂單表 (orders)

**欄位：**
- id：UUID，主鍵
- order_number：文字，唯一（格式：ORD-20250101-001）
- user_id：UUID，外鍵連接 users.id
- order_date：時間戳記，預設當前時間
- status：文字，預設'pending'，可選值(pending/processing/shipped/completed/cancelled)
- total_amount：數字（小數點2位）
- delivery_address：文字
- notes：文字，可為空

**外鍵約束：**
- user_id → users.id（刪除使用者時訂單設為 NULL）

## 表4：訂單明細表 (order_items)

**欄位：**
- id：UUID，主鍵
- order_id：UUID，外鍵連接 orders.id
- product_id：UUID，外鍵連接 products.id
- quantity：整數，不能為空
- unit_price：數字（小數點2位）
- subtotal：數字（小數點2位）

**外鍵約束：**
- order_id → orders.id（刪除訂單時一起刪除明細）
- product_id → products.id（刪除商品時明細保留但標記）

請產生建立這些表的 SQL 語法，並加上適當的註解。
```

---

## 4️⃣ 手動功能測試說明

### 測試環境準備
1. 登入 Supabase Dashboard
2. 進入 SQL Editor
3. 準備測試用的資料

### 測試案例清單

| 編號 | 測試項目 | 測試步驟 | 預期結果 |
|------|---------|---------|---------|
| T01 | 建立資料表 | 執行建表 SQL | 4個資料表建立成功 |
| T02 | 唯一約束 | 插入重複 username | 錯誤：violates unique constraint |
| T03 | 非空約束 | 插入空的 email | 錯誤：violates not-null constraint |
| T04 | 外鍵約束 | 訂單關聯不存在的 user_id | 錯誤：violates foreign key constraint |
| T05 | 預設值 | 新增訂單不填 status | 自動填入 'pending' |
| T06 | 級聯刪除 | 刪除訂單 | 訂單明細同時刪除 |
| T07 | 索引效能 | 查詢大量資料 | 有索引欄位查詢較快 |

### 異常情況處理

| 異常情況 | 預期系統反應 |
|---------|-------------|
| 資料類型錯誤 | 顯示類型轉換錯誤 |
| 超出欄位長度 | 顯示資料截斷警告 |
| 連線數過多 | Supabase 限制提示 |
