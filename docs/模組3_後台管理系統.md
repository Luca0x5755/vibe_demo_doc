# 📦 模組3: 後台管理系統

## 1️⃣ 第一性原理拆解

**核心知識點：權限管理 (Authorization)**

```
最根本的問題：
「不同的人能做不同的事」

生活類比：
├─ 超市員工：只能收銀
├─ 店長：能收銀+查看報表+管理員工
└─ 總部：能看所有店的資料

軟體中的實現：
角色(Role) + 權限(Permission) = 能做什麼
```

**拆解成4個子問題：**
1. **角色定義**：「系統有哪些角色？」
2. **權限分配**：「每個角色能做什麼？」
3. **權限檢查**：「怎麼確認某人有權限做某事？」
4. **介面呈現**：「不同角色看到不同畫面」

---

## 2️⃣ 模組設計

### 設計目標
建立完整的角色權限系統，控制不同身份的操作範圍。

### 核心功能
| 功能 | 說明 |
|------|------|
| 訂單管理 | 查看、篩選、修改訂單狀態 |
| 商品管理 | 新增、編輯、下架商品 |
| 使用者管理 | 查看用戶、修改角色、停用帳號 |

### 角色權限矩陣

| 功能 | 超級管理員 | 一般管理員 | 客戶經理 | 一般客戶 |
|------|:----------:|:----------:|:--------:|:--------:|
| 訂單列表(全部) | ✅ | ✅ | ❌ | ❌ |
| 訂單列表(自己的) | ✅ | ✅ | ✅ | ✅ |
| 修改訂單狀態 | ✅ | ✅ | ❌ | ❌ |
| 商品管理 | ✅ | ✅ | ❌ | ❌ |
| 使用者管理 | ✅ | ❌ | ❌ | ❌ |
| 系統設定 | ✅ | ❌ | ❌ | ❌ |
| CRM客戶資料 | ✅ | ✅ | ✅ | ❌ |

### 可維護性設計：中介層

**設計原則**：權限邏輯集中管理，不寫死在頁面上

```python
# permission_checker.py
# 所有頁面都呼叫這個檢查器
def can_user_do(user_role: str, action: str) -> bool:
    permissions = load_permissions_config()
    return action in permissions.get(user_role, [])
```

**好處**：未來改權限只要改設定檔，不用改程式碼

---

## 3️⃣ AI 協作開發提示詞

### 完整 Prompt 範本

```markdown
# 後台管理系統需求

## 系統角色
我需要4種角色：超級管理員、一般管理員、客戶經理、一般客戶

權限分配如下：
[貼上上方的權限矩陣]

## 主要功能

### 1. 訂單管理
- 列表顯示所有訂單（依權限過濾）
- 可以篩選：訂單狀態、日期範圍、客戶名稱
- 點擊訂單可以看詳細資訊
- 管理員可以修改訂單狀態（待處理→處理中→已出貨→已完成）

### 2. 商品管理（僅管理員）
- 新增商品（名稱、價格、庫存）
- 編輯商品資訊
- 下架商品（不刪除，只是不顯示）

### 3. 使用者管理（僅超級管理員）
- 查看所有使用者列表
- 修改使用者角色
- 停用/啟用帳號

## 介面需求
- 左側選單（依角色顯示不同選項）
- 上方顯示目前登入者身份
- 每個功能區塊都要檢查權限（沒權限顯示「無權訪問」）

## 技術需求
- 後台使用 Streamlit 建構（快速開發）
- 資料來自 Supabase
- 權限檢查要在每個頁面載入時執行

請生成這個後台管理系統的程式碼。
```

### 中介層設計 Prompt

```markdown
請建立一個權限檢查器（permission_checker.py）
- 定義每個角色的權限清單
- 提供函式：can_user_do(user_role, action)
- 所有頁面都呼叫這個檢查器
這樣未來改權限只要改一個檔案
```

---

## 4️⃣ 手動功能測試說明

### 測試環境準備
1. 確認 Supabase 資料庫已連線
2. 準備4種角色的測試帳號
3. 啟動 Streamlit 後台 (`streamlit run admin.py`)

### 測試案例清單

| 編號 | 測試項目 | 測試角色 | 測試步驟 | 預期結果 |
|------|---------|---------|---------|---------|
| T01 | 超級管理員全權限 | super_admin | 訪問所有功能頁面 | 全部可訪問 |
| T02 | 一般管理員權限 | admin | 訪問使用者管理 | 顯示「無權訪問」 |
| T03 | 客戶經理權限 | manager | 查看訂單列表 | 只看到自己負責的客戶訂單 |
| T04 | 一般客戶權限 | customer | 訪問商品管理 | 選單中不顯示此項目 |
| T05 | 訂單狀態修改 | admin | 將訂單從「待處理」改為「處理中」 | 狀態更新成功 |
| T06 | 商品下架 | admin | 點擊商品「下架」按鈕 | 商品從列表隱藏，資料庫標記 is_active=false |
| T07 | 停用帳號 | super_admin | 停用某用戶帳號 | 該用戶無法登入 |

### 異常情況處理

| 異常情況 | 預期系統反應 |
|---------|-------------|
| 未登入訪問後台 | 導向登入頁面 |
| Token 過期 | 提示重新登入 |
| 權限被修改後 | 下次操作立即生效 |
